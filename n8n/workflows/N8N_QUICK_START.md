# n8n Webhook - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–§–∞–∑–∞ 2)

**–î–∞—Ç–∞:** 2025-12-21
**–í–µ—Ä—Å–∏—è:** 2.1 (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è)
**–§–∞–π–ª workflow:** `Getcourse_webhook_insert.json`

---

## ‚úÖ –ß—Ç–æ –≤ —ç—Ç–æ–º workflow

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –∏ —Ç–∏–ø–æ–≤
2. **–ó–∞–ø–∏—Å—å –≤ PostgreSQL** - INSERT –≤ `webhook_events` —Å `processed = false`
3. **–†–∞–∑–¥–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫**:
   - –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ‚Üí –ê–ª–µ—Ä—Ç: –í–∞–ª–∏–¥–∞—Ü–∏—è
   - –û—à–∏–±–∫–∞ –ë–î ‚Üí –ê–ª–µ—Ä—Ç: –ë–î

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (8 –Ω–æ–¥):

```
Webhook ‚Üí –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö ‚Üí –ó–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î ‚Üí –í—ã—Ö–æ–¥
              ‚Üì (error)           ‚Üì (error)
              v                   v
       –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏      –û—à–∏–±–∫–∞ –ë–î
              ‚Üì                   ‚Üì
       –ê–ª–µ—Ä—Ç: –í–∞–ª–∏–¥–∞—Ü–∏—è      –ê–ª–µ—Ä—Ç: –ë–î
              ‚Üì                   ‚Üì
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          v
                        –í—ã—Ö–æ–¥
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (20 –∑–∞–ø—Ä–æ—Å–æ–≤, 1 —Å–µ–∫): **100% —É—Å–ø–µ—Ö**
- ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç (100 –∑–∞–ø—Ä–æ—Å–æ–≤, 500ms): **100% —É—Å–ø–µ—Ö**
- ‚ö†Ô∏è –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç **2-3 –∑–∞–ø—Ä–æ—Å–∞/—Å–µ–∫** —Å—Ç–∞–±–∏–ª—å–Ω–æ

---

## üöÄ –ò–º–ø–æ—Ä—Ç workflow

### 1. –ó–∞–π—Ç–∏ –≤ n8n
```
URL: https://spiderdad.ru/
```

### 2. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª
```
Workflows ‚Üí Getcourse_webhook_insert ‚Üí ... ‚Üí Import from File
‚Üí –í—ã–±—Ä–∞—Ç—å: n8n/workflows/Getcourse_webhook_insert.json
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å 8 –Ω–æ–¥:**
1. ‚úÖ **Webhook** - –ø—Ä–∏–µ–º POST –∑–∞–ø—Ä–æ—Å–æ–≤
2. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** (Code, —Å error output)
3. ‚úÖ **–ó–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î** (PostgreSQL, —Å error output)
4. ‚úÖ **–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏** (Code)
5. ‚úÖ **–ê–ª–µ—Ä—Ç: –í–∞–ª–∏–¥–∞—Ü–∏—è** (Telegram)
6. ‚úÖ **–û—à–∏–±–∫–∞ –ë–î** (Code)
7. ‚úÖ **–ê–ª–µ—Ä—Ç: –ë–î** (Telegram)
8. ‚úÖ **–í—ã—Ö–æ–¥** (NoOp)

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:**
- Webhook ‚Üí –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (main)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö ‚Üí –ó–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î (main success)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö ‚Üí –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (error)
- –ó–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î ‚Üí –í—ã—Ö–æ–¥ (main success)
- –ó–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î ‚Üí –û—à–∏–±–∫–∞ –ë–î (error)
- –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ‚Üí –ê–ª–µ—Ä—Ç: –í–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí –í—ã—Ö–æ–¥
- –û—à–∏–±–∫–∞ –ë–î ‚Üí –ê–ª–µ—Ä—Ç: –ë–î ‚Üí –í—ã—Ö–æ–¥

### 4. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
```
Toggle "Active" ‚Üí ON (–∑–µ–ª–µ–Ω—ã–π)
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å
```bash
curl -X POST https://spiderdad.ru/webhook/getcoursebd \
  -H "Content-Type: application/json" \
  -d '{
    "eventDate": "2025-12-21T12:00:00Z",
    "userId": 12345,
    "userEmail": "test@example.com",
    "answerId": 67890
  }'
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- ‚úÖ HTTP 200
- ‚úÖ –ó–∞–ø–∏—Å—å –≤ PostgreSQL
- ‚úÖ –ù–ï–¢ –∞–ª–µ—Ä—Ç–∞ –≤ Telegram

---

### –¢–µ—Å—Ç 2: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
```bash
curl -X POST https://spiderdad.ru/webhook/getcoursebd \
  -H "Content-Type: application/json" \
  -d '{
    "eventDate": "2025-12-21T12:00:00Z"
  }'
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- ‚úÖ Telegram –∞–ª–µ—Ä—Ç:
  ```
  üõë –û–®–ò–ë–ö–ê –í–ê–õ–ò–î–ê–¶–ò–ò WEBHOOK

  –û—à–∏–±–∫–∞: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: userId, userEmail, answerId

  üì¶ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
  eventDate: 2025-12-21T12:00:00Z
  ```

---

### –¢–µ—Å—Ç 3: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö
```bash
curl -X POST https://spiderdad.ru/webhook/getcoursebd \
  -H "Content-Type: application/json" \
  -d '{
    "eventDate": "not-a-date",
    "userId": 12345,
    "userEmail": "test@example.com",
    "answerId": 67890
  }'
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- ‚úÖ Telegram –∞–ª–µ—Ä—Ç:
  ```
  üõë –û–®–ò–ë–ö–ê –í–ê–õ–ò–î–ê–¶–ò–ò WEBHOOK

  –û—à–∏–±–∫–∞: eventDate –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π –¥–∞—Ç–æ–π, –ø–æ–ª—É—á–µ–Ω–æ: not-a-date

  üì¶ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
  eventDate: not-a-date
  userId: 12345
  userEmail: test@example.com
  answerId: 67890
  ```

---

## üìä –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
cd n8n/workflows/tests_results
python test_run_load.py --requests 100 --delay-ms 500 --verbose
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–µ—Å—Ç–∞:**
- ‚úÖ 100% —É—Å–ø–µ—Ö (100/100)
- ‚úÖ 0 –ø–æ—Ç–µ—Ä—å
- ‚úÖ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: 7.45 —Å–µ–∫
- ‚úÖ –í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ PostgreSQL

**–í—ã–≤–æ–¥:** –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 2-3 –∑–∞–ø—Ä–æ—Å–∞/—Å–µ–∫

---

---

## üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ Credentials

### PostgreSQL (–Ω–æ–¥–∞ "–ó–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î")
```
Host: getcoursebd-spiderdad.db-msk0.amvera.tech
Port: 5432
Database: GetCourseBD
User: postgresql
Password: (–∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è n8n)
```

### Telegram (–Ω–æ–¥—ã "–ê–ª–µ—Ä—Ç: –í–∞–ª–∏–¥–∞—Ü–∏—è" –∏ "–ê–ª–µ—Ä—Ç: –ë–î")
```
Chat ID: -1003386133985
Bot Token: (–∏–∑ Credentials ‚Üí Telegram account)
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ PostgreSQL

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø–∏—Å–∏:

```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
SELECT COUNT(*) FROM webhook_events
WHERE created_at > NOW() - INTERVAL '1 hour';

-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π
SELECT id, user_id, user_email, answer_id, processed, created_at
FROM webhook_events
ORDER BY id DESC
LIMIT 10;
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π = —É—Å–ø–µ—à–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º –≤ —Ç–µ—Å—Ç–µ
- –í—Å–µ –∑–∞–ø–∏—Å–∏ –∏–º–µ—é—Ç `processed = false`
- –ü–æ–ª–µ `raw_payload` —Å–æ–¥–µ—Ä–∂–∏—Ç JSONB

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è workflow –≥–æ—Ç–æ–≤ –∫ production!

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- üìñ –ü–æ–ª–Ω–∞—è: `getcourse_bot/REFACTORING_PHASE2.md`
- üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: `tests/N8N_TESTING_GUIDE.md`
- üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: —Å–º. —Ä–∞–∑–¥–µ–ª "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞" –≤ REFACTORING_PHASE2.md
