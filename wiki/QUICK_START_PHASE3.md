# üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑—ã 3

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –≤ production

---

## –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```powershell
cd getcourse_bot

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
.\venv\Scripts\activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ pytz
python -c "import pytz; print(f'pytz version: {pytz.__version__}')"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
pytz version: 2024.1
```

---

## –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```powershell
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .env
type .env | findstr "DB_TYPE\|SERVER_ENV\|POSTGRES"

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# DB_TYPE=postgresql
# SERVER_ENV=dev
# POSTGRES_HOST_EXTERNAL=getcoursebd-spiderdad.db-msk0.amvera.tech
# POSTGRES_USER=postgresql
# POSTGRES_DB=GetCourseBD

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
type .env | findstr "WEBHOOK_PROCESSING\|DEADLINE_CHECK\|NOTIFICATION_SEND"
```

**–ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–µ—Ç - –¥–æ–±–∞–≤–∏—Ç—å –∏–∑ env.example:**

```bash
WEBHOOK_PROCESSING_INTERVAL=30
DEADLINE_CHECK_INTERVAL_MINUTES=60
NOTIFICATION_SEND_INTERVAL=15
DEADLINE_WARNING_HOURS=36
REMINDER_TRIGGER_HOUR=12
REMINDER_ANALYSIS_DAYS_BACK=2
WEBHOOK_BATCH_SIZE=50
NOTIFICATION_BATCH_SIZE=20
```

---

## –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–æ–Ω

```powershell
python tests/test_timezone_verification.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
============================================================
–ü–†–û–í–ï–†–ö–ê –ù–ê–°–¢–†–û–ï–ö POSTGRESQL
============================================================
1. –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ PostgreSQL —Å–µ—Ä–≤–µ—Ä–∞: UTC
2. UTC input: 2025-12-21 18:50:57+00:00
   Moscow display: 2025-12-21 21:50:57
...
============================================================
–í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!
============================================================
```

---

## –®–∞–≥ 4: Unit-—Ç–µ—Å—Ç—ã

```powershell
# –¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
python tests/test_notification_calculator.py

# –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–æ–≤
python tests/test_webhook_processor.py

# –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–¥–ª–∞–π–Ω–æ–≤
python tests/test_deadline_checker.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –ø—Ä–æ–π–¥–µ–Ω
‚úÖ –¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–¥–ª–∞–π–Ω–∞ –ø—Ä–æ–π–¥–µ–Ω
‚úÖ –¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–æ–π–¥–µ–Ω
‚úÖ –¢–µ—Å—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–æ–Ω –ø—Ä–æ–π–¥–µ–Ω
```

---

## –®–∞–≥ 5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç

**–í–ê–ñ–ù–û:** –¢—Ä–µ–±—É–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL!

```powershell
python tests/test_manual_full_cycle.py
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–º–µ–Ω—Ç–æ—Ä, —Å—Ç—É–¥–µ–Ω—Ç, —Ç—Ä–µ–Ω–∏–Ω–≥, —É—Ä–æ–∫, mapping)
2. –°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π –≤–µ–±—Ö—É–∫
3. –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É
4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
5. –£–¥–∞–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
============================================================
–°–û–ó–î–ê–ù–ò–ï –¢–ï–°–¢–û–í–´–• –î–ê–ù–ù–´–•
============================================================
‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –º–µ–Ω—Ç–æ—Ä
‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å—Ç—É–¥–µ–Ω—Ç
‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Ç—Ä–µ–Ω–∏–Ω–≥
‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —É—Ä–æ–∫
‚úÖ –°–æ–∑–¥–∞–Ω mapping

‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã:
   –ú–µ–Ω—Ç–æ—Ä ID: 1 (GetCourse: 99999)
   –°—Ç—É–¥–µ–Ω—Ç ID: 1 (GetCourse: 88888)
   ...

============================================================
–¢–ï–°–¢ –ü–û–õ–ù–û–ì–û –¶–ò–ö–õ–ê –û–ë–†–ê–ë–û–¢–ö–ò
============================================================
1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–µ–±—Ö—É–∫–∞...
   ‚úÖ –í–µ–±—Ö—É–∫ —Å–æ–∑–¥–∞–Ω, ID: 220

2. –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–∞...
   INFO - –ù–∞–π–¥–µ–Ω–æ 1 –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –≤–µ–±—Ö—É–∫–æ–≤
   INFO - –°–æ–∑–¥–∞–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –º–µ–Ω—Ç–æ—Ä–∞ ...

3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...
   –í–µ–±—Ö—É–∫ processed: True
   ‚úÖ –í–µ–±—Ö—É–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ

4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...
   –°–æ–∑–¥–∞–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: 1
   ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω—ã

============================================================
–¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù
============================================================
```

---

## –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ PostgreSQL

**–ß–µ—Ä–µ–∑ DBeaver:**

```sql
-- 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
SELECT COUNT(*) FROM mentors WHERE valid_to = '9999-12-31'::TIMESTAMPTZ;
SELECT COUNT(*) FROM students WHERE valid_to = '9999-12-31'::TIMESTAMPTZ;
SELECT COUNT(*) FROM trainings WHERE valid_to = '9999-12-31'::TIMESTAMPTZ;
SELECT COUNT(*) FROM lessons WHERE valid_to = '9999-12-31'::TIMESTAMPTZ;
SELECT COUNT(*) FROM mapping WHERE valid_to = '9999-12-31'::TIMESTAMPTZ;

-- 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏–ª–∏ test_manual_full_cycle.py)
SELECT * FROM mentors WHERE mentor_id = 99999;
SELECT * FROM students WHERE student_id = 88888;

-- 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å, –µ—Å–ª–∏ —Ç–µ—Å—Ç –æ—á–∏—Å—Ç–∏–ª)
SELECT COUNT(*) FROM webhook_events WHERE user_id = 88888;
SELECT COUNT(*) FROM notifications WHERE created_at > NOW() - INTERVAL '1 hour';
```

---

## –®–∞–≥ 7: –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```powershell
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ .env –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ dev
# SERVER_ENV=dev

# –ó–∞–ø—É—Å–∫
python main.py
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**
```
INFO - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î: —Ç–∏–ø=postgresql, URL=...
INFO - PostgreSQL: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ getcoursebd-spiderdad.db-msk0.amvera.tech
INFO - ‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î —É—Å–ø–µ—à–Ω–∞
INFO - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ long polling
INFO - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω
```

**–ß–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥:**
```
DEBUG - –ù–µ—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –≤–µ–±—Ö—É–∫–æ–≤
```

**–ß–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥:**
```
DEBUG - –ù–µ—Ç pending —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```

**–ß–µ—Ä–µ–∑ 1 —á–∞—Å:**
```
INFO - –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è –¥–µ–¥–ª–∞–π–Ω–æ–≤
INFO - –ù–µ—Ç –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è –¥–µ–¥–ª–∞–π–Ω–æ–≤
INFO - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–¥–ª–∞–π–Ω–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°–æ–∑–¥–∞–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: 0
```

---

## Troubleshooting

### –û—à–∏–±–∫–∞: "ModuleNotFoundError: No module named 'pytz'"

**–†–µ—à–µ–Ω–∏–µ:**
```powershell
pip install pytz==2024.1
```

### –û—à–∏–±–∫–∞: "No module named 'bot.services.webhook_processor'"

**–ü—Ä–∏—á–∏–Ω–∞:** –§–∞–π–ª—ã –Ω–µ —Å–æ–∑–¥–∞–Ω—ã –∏–ª–∏ –Ω–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
```powershell
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤
dir bot\services\webhook_processor.py
dir bot\services\notification_calculator.py
dir bot\services\deadline_checker.py
dir bot\services\reminder_service.py
dir bot\services\notification_sender.py
```

### –û—à–∏–±–∫–∞: "TimeoutError" –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ PostgreSQL

**–†–µ—à–µ–Ω–∏–µ:**
```powershell
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .env
type .env | findstr POSTGRES

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
Test-NetConnection -ComputerName getcoursebd-spiderdad.db-msk0.amvera.tech -Port 5432
```

### –û—à–∏–±–∫–∞: "–ù–µ –Ω–∞–π–¥–µ–Ω –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞..."

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ `mapping`

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å mapping
SELECT * FROM v_active_mappings;

-- –ï—Å–ª–∏ –ø—É—Å—Ç–æ - —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ test_manual_full_cycle.py
```

---

## –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –°–ª–∏—è–Ω–∏–µ –≤–µ—Ç–æ–∫

```powershell
git checkout refactoring
git merge refactoring/phase3-business-logic

# –ü—Ä–æ–≤–µ—Ä–∫–∞
git log --oneline -5
git status
```

### 2. –ö–æ–º–º–∏—Ç –∏ push

```powershell
git add .
git status

# –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git commit -m "feat: Phase 3 - Business logic migration (GAS ‚Üí Python)

- –°–æ–∑–¥–∞–Ω–æ 5 –Ω–æ–≤—ã—Ö Python-—Å–µ—Ä–≤–∏—Å–æ–≤
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (PostgreSQL)
- –û–±–Ω–æ–≤–ª–µ–Ω main.py (4 –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ APScheduler)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç—ã
- –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω README –≤ getcourse_apps_script

–ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å Google Apps Script –Ω–∞ Python + PostgreSQL + n8n
"

git push origin refactoring
```

### 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ production

–°–º. `wiki/REFACTORING_COMPLETE.md` –∏ `wiki/PHASE3_COMPLETE.md`

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-21
**–ì–æ—Ç–æ–≤–æ –∫ production:** –ü–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL
