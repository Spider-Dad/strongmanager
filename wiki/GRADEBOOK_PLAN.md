### План разработки табеля успеваемости студентов (Mentor/Admin)

- **Цель**: предоставить наставникам и администраторам краткие, информативные сводки успеваемости студентов в Telegram‑боте с доступом строго по ролям и синхронизацией с Google Sheets и БД.
- **Ограничения**: не ломать существующий функционал бота и GAS; минимальные инвазивные изменения; использовать существующие модули и паттерны проекта.

### 1) Аналитика и проектирование — СДЕЛАНО
- **Роли и доступ**:
  - **Наставник**: видит только своих студентов (на основе `mapping` и авторизации через `Mentor.telegram_id`). Команда: `/progress`.
  - **Администратор**: видит агрегированную картину по наставникам и урокам. Команда: `/progress_admin` (доступ по `config.admin_ids`).
- **Статусы и категоризация** (определяются по `lessons.deadline_date` и данным из `logs`):
  - **Не сдал (до дедлайна)**: ответа нет и now < deadline.
  - **Не сдал (после дедлайна)**: ответа нет и now ≥ deadline.
  - **Сдал вовремя**: есть ответ и answer_date ≤ deadline.
  - **Сдал с опозданием**: есть ответ и answer_date > deadline — относится к категории **«не вовремя»** и также отображается как отдельный статус.
- **Формат Telegram‑выдачи**:
  - Короткие агрегаты + inline‑кнопки (фильтры по тренингу/уроку/статусу, пагинация). Сообщения не перегружать; при необходимости разбивать на несколько.
- **Google Sheets** (добавочные листы, только чтение):
  - `progress_config` — конфигурация табеля (приоритеты/веса/override‑дедлайны/видимость).
  - `progress_overrides` — ручные корректировки статусов (поверх вычислений).
- **Выходы этапа**: финализированная схема статусов, дизайн команд и форматов сообщений, схема листов Google, ERD изменений БД, критерии приёмки.
- **Тесты этапа**: чек‑лист сценариев и snapshot‑примеры сообщений (без кода), договорённые критерии успешности.

### 2) Данные и синхронизация (БД ↔ Google Sheets) — СДЕЛАНО
- **Изменения в данных**:
  - Новые таблицы БД:
    - `progress_config` (id, training_id, lesson_id [опционально], deadline_override [опционально], weight [опционально], tags [опционально], visibility [опционально]).
    - `progress_overrides` (id, student_id, lesson_id, status_override, comment [опционально], expires_at [опционально]).
  - Индексы по `training_id`, `lesson_id`, `student_id`.
- **Синхронизация**:
  - Расширение существующего сервиса синхронизации для чтения листов `progress_config`, `progress_overrides` cо scope `spreadsheets.readonly`.
  - Валидация, логирование количества записей, отсутствие влияния на текущие таблицы.
- **Совместимость**: не изменять текущие таблицы и поток синка; только добавить чтение и запись в новые сущности.
- **Тесты этапа**:
  - Тесты чтения листов (моки/фикстуры данных), валидации схем и записи в БД.
  - Интеграционный прогон синка с проверкой метрик и логов.

### 3) Сервис табеля (бизнес‑логика) — СДЕЛАНО
- **Модуль**: `bot/services/gradebook_service.py`.
- **Функции**:
  - Расчёт статусов по студентам и урокам на основе `lessons.deadline_date`, записей из `logs` (первый ответ по `answer_lesson_id`) и `progress_config`/`progress_overrides`.
  - Категоризация статусов (включая «сдал с опозданием» как «не вовремя» + явное отображение).
  - Агрегации:
    - Для наставника: сводка по своим студентам и урокам (отстающие/успешные; тренды по урокам).
    - Для администратора: сводки по наставникам (кол-во отстающих), по урокам (массовые провалы), обнаружение групп риска.
- **Производительность**: выборки с учётом индексов; ленивые детали по кнопкам; ограничение размера сообщений.
- **Тесты этапа**:
  - Юнит‑тесты на правила дедлайнов, определение статусов, применение overrides — СДЕЛАНО (тесты категоризации добавлены).
  - Тесты агрегатов (корректность подсчётов и сортировок) — СДЕЛАНО (базовый интеграционный тест).

### 4) Команды бота и интерфейс (aiogram) — СДЕЛАНО
- **Хендлеры**: `bot/handlers/gradebook.py` — команды `/progress`, `/progress_admin`; единый роутер callback `gb:*` (выбор тренинга, выбор урока, фильтр статусов, сброс) — СДЕЛАНО.
- **Клавиатуры**: `bot/keyboards/gradebook.py` — фильтры, выбор тренинга, выбор урока — СДЕЛАНО.
- **Доступ**: админ — `config.admin_ids`; наставник — авторизованный `Mentor.telegram_id`. Порядок регистрации не конфликтует с текущими обработчиками.
- **Выдача**: краткие агрегаты; детализация по кнопкам; безопасное экранирование Markdown.
- **Тесты этапа**:
  - Интеграционные тесты команд и callback‑ов — БАЗОВО (snapshot форматтеров добавлен; полноценные e2e с Telegram API не требуются на этом этапе).
  - Snapshot‑проверки форматирования сообщений — СДЕЛАНО.

### 5) Приёмка, документация и релиз — СДЕЛАНО
- **Документация**:
  - Описание листов `progress_config`, `progress_overrides` (колонки, типы, примеры) — СДЕЛАНО ранее.
  - Руководство/Release Notes — СДЕЛАНО: `wiki/GRADEBOOK_RELEASE_NOTES.md` (бот), `getcourse_apps_script/docs/gradebook/RELEASE_NOTES.md` (GAS).
- **Ввод в эксплуатацию**:
  - Фича‑флаг/ENV `GRADEBOOK_ENABLED` для включения команд — СДЕЛАНО (по умолчанию false).
  - Деплой без изменений существующего функционала бота и GAS.
- **Критерии приёмки**:
  - Наставник по `/progress` видит только своих студентов; статусы корректны, «сдал с опозданием» учитывается как «не вовремя» и отображается явно — ПРОЙДЕНО на тестовых данных.
  - Администратор по `/progress_admin` получает корректные агрегаты по наставникам и урокам; выявляются группы риска — ПРОЙДЕНО (логика агрегатов покрыта тестами).
  - Новые листы читаются и синхронизируются в БД; существующая синхронизация не нарушена — ПРОЙДЕНО (этап 2).
- **Тесты этапа**:
  - Регресс по основным сценариям бота и синка; мониторинг логов после выкладки.

### Примечание о процессе
- Реализация ведётся поэтапно. По завершении каждого этапа добавляются и запускаются тесты соответствующего уровня (юнит/интеграция), фиксируются артефакты (логи синка, snapshot‑сообщения), и выполняется промежуточная приёмка перед переходом к следующему этапу.

### Ветки разработки (по этапам)
- В разработке используются отдельные ветки по этапам в обоих репозиториях. Слияние — через PR в основной ветке после прохождения тестов и промежуточной приёмки.

- Репозиторий `getcourse_bot`:
  - Этап 1 (Аналитика и проектирование): `getcourse_bot/feature/gradebook-stage-1-analysis`
  - Этап 2 (Данные и синхронизация): `getcourse_bot/feature/gradebook-stage-2-sync`
  - Этап 3 (Сервис табеля): `getcourse_bot/feature/gradebook-stage-3-service`
  - Этап 4 (Команды бота и UI): `getcourse_bot/feature/gradebook-stage-4-bot-ui`
  - Этап 5 (Приёмка и релиз): `getcourse_bot/feature/gradebook-stage-5-release`

- Репозиторий `getcourse_apps_script` (изменения при необходимости, например документация листов/утилиты):
  - Этап 1: `getcourse_apps_script/feature/gradebook-stage-1-analysis`
  - Этап 2: `getcourse_apps_script/feature/gradebook-stage-2-sync`
  - Этап 3: `getcourse_apps_script/feature/gradebook-stage-3-service`
  - Этап 4: `getcourse_apps_script/feature/gradebook-stage-4-bot-ui`
  - Этап 5: `getcourse_apps_script/feature/gradebook-stage-5-release`
