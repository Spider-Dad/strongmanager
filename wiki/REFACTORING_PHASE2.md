# –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ GetCourse Bot - –§–∞–∑–∞ 2: n8n Webhook Integration

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ
**–î–∞—Ç–∞:** 2025-12-21
**–í–µ—Ç–∫–∞:** `refactoring/phase2-n8n-webhooks`

---

## –¶–µ–ª—å –§–∞–∑—ã 2

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ n8n workflow –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç GetCourse —Å –∑–∞–ø–∏—Å—å—é –≤ PostgreSQL –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö.

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ù–æ–≤–∞—è –Ω–æ–¥–∞:** `–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö` (JavaScript Code node)

**–§—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π**:
  - `eventDate` - –¥–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è
  - `userId` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `userEmail` - email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `answerId` - ID –æ—Ç–≤–µ—Ç–∞

- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ **—Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö**:
  - `userId` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º (INTEGER)
  - `answerId` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º (INTEGER)
  - `userEmail` –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–∏–º–≤–æ–ª `@`
  - `eventDate` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π –¥–∞—Ç–æ–π (ISO 8601)

- ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ **—Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö**:
  - –£–∫–∞–∑–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π
  - –í—ã–≤–æ–¥ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
  - –ü–æ–ª–Ω—ã–π JSON –≤–µ–±—Ö—É–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ–± –æ—à–∏–±–∫–µ

**–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
```javascript
const body = $json.body || {};

const requiredFields = ['eventDate', 'userId', 'userEmail', 'answerId'];
const missingFields = requiredFields.filter(field => {
  const value = body[field];
  return value === undefined || value === null || value === '';
});

if (missingFields.length > 0) {
  throw new Error(
    `–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: ${missingFields.join(', ')}`
  );
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö...
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ –ë–î
- üêõ –†–∞–Ω–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —Ñ–æ—Ä–º–∞—Ç–æ–º –≤–µ–±—Ö—É–∫–æ–≤
- üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫

---

### 2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —è–≤–Ω–æ–µ –ø–æ–ª–µ `processed = false`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ PostgreSQL INSERT node:**

```json
"columns": {
  "value": {
    "event_date": "={{ $json.body.eventDate }}",
    "user_id": "={{ $json.body.userId }}",
    "user_email": "={{ $json.body.userEmail }}",
    ...
    "raw_payload": "={{ $json.body }}",
    "processed": false  // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û –Ø–í–ù–û
  }
}
```

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**
- ‚úÖ –Ø–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç DEFAULT –∑–Ω–∞—á–µ–Ω–∏—è –≤ PostgreSQL
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ –Ω–æ–≤—ã–µ –≤–µ–±—Ö—É–∫–∏ –ø–æ–ø–∞–¥—É—Ç –≤ –æ—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–î–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è:** –∑–Ω–∞—á–µ–Ω–∏–µ `processed` –±—Ä–∞–ª–æ—Å—å –∏–∑ `DEFAULT FALSE` –≤ —Å—Ö–µ–º–µ –ë–î
**–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:** –∑–Ω–∞—á–µ–Ω–∏–µ `processed = false` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —è–≤–Ω–æ –≤ n8n

---

### 3. ‚úÖ –†–∞–∑–¥–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–°–æ–∑–¥–∞–Ω–æ 2 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:**

#### 3.1. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
**–ù–æ–¥–∞:** `–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏` ‚Üí `–ê–ª–µ—Ä—Ç: –í–∞–ª–∏–¥–∞—Ü–∏—è`

**–§—É–Ω–∫—Ü–∏–∏:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö (–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ç–∏–ø—ã)
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–Ω—è—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Telegram
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–∏–º–µ—Ä –∞–ª–µ—Ä—Ç–∞:**
```
üõë –û–®–ò–ë–ö–ê –í–ê–õ–ò–î–ê–¶–ò–ò WEBHOOK

–û—à–∏–±–∫–∞: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: userId, userEmail

üì¶ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
eventDate: 2025-12-21T12:00:00Z
answerId: 67890

–í—Ä–µ–º—è: 2025-12-21T10:30:45.123Z
```

#### 3.2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –ë–î
**–ù–æ–¥–∞:** `–û—à–∏–±–∫–∞ –ë–î` ‚Üí `–ê–ª–µ—Ä—Ç: –ë–î`

**–§—É–Ω–∫—Ü–∏–∏:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–ø–∏—Å–∏ –≤ PostgreSQL (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –ë–î, constraint violation, timeout)
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤–µ–±—Ö—É–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å

**–ü—Ä–∏–º–µ—Ä –∞–ª–µ—Ä—Ç–∞:**
```
üõë –û–®–ò–ë–ö–ê –ó–ê–ü–ò–°–ò –í POSTGRESQL

–û—à–∏–±–∫–∞: Connection timeout

üì¶ –î–∞–Ω–Ω—ã–µ –≤–µ–±—Ö—É–∫–∞:
eventDate: 2025-12-21T12:00:00Z
userId: 12345
userEmail: test@example.com
answerId: 67890

–í—Ä–µ–º—è: 2025-12-21T10:30:45.123Z
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–∞–∑–¥–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –∏ –ø–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ workflow
- ‚úÖ –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏
- ‚úÖ –ü—Ä–æ—â–µ –æ—Ç–ª–∞–¥–∫–∞ (—Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ, –≥–¥–µ –ø—Ä–æ–±–ª–µ–º–∞: –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏–ª–∏ –ë–î)

---

### 4. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test_run_load.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

#### 4.1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
**–î–æ:**
```python
"userId": "12345",        # –°—Ç—Ä–æ–∫–∞
"answerId": "67890",      # –°—Ç—Ä–æ–∫–∞
```

**–ü–æ—Å–ª–µ:**
```python
"userId": 12345,          # INTEGER (—Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ö–µ–º–µ PostgreSQL)
"answerId": 67890,        # INTEGER
```

#### 4.2. –î–æ–±–∞–≤–ª–µ–Ω –ø–æ—Ä–æ–≥ —É—Å–ø–µ—Ö–∞ 99.9%
```python
threshold_99_9 = 0.1  # 0.1% –ø–æ—Ç–µ—Ä—å = 99.9% —É—Å–ø–µ—Ö–∞

if loss_percent <= threshold_99_9:
    print("‚úÖ –û–¢–õ–ò–ß–ù–û: –ü–æ—Ä–æ–≥ —É—Å–ø–µ—Ö–∞ 99.9% –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!")
else:
    print("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ü–æ—Ä–æ–≥ —É—Å–ø–µ—Ö–∞ 99.9% –ù–ï –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!")
```

#### 4.3. –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
```python
request_body["answerId"] = 67890 + request_counter  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
request_body["userId"] = 12345 + request_counter    # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö —Å—Ö–µ–º–µ PostgreSQL
- ‚úÖ –ß–µ—Ç–∫–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ UNIQUE constraint

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ workflow (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   Webhook   ‚îÇ  POST /getcoursebd
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           v
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö     ‚îÇ  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π –∏ —Ç–∏–ø–æ–≤
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ (–æ—à–∏–±–∫–∞)        ‚îÇ (—É—Å–ø–µ—Ö)         ‚îÇ
         v                 v                 ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ‚îÇ  ‚îÇ  –ó–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î   ‚îÇ  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
         ‚îÇ                     ‚îÇ             ‚îÇ
         v                     ‚îÇ             ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ –ê–ª–µ—Ä—Ç: –í–∞–ª–∏–¥–∞—Ü–∏—è ‚îÇ    ‚îÇ(—É—Å–ø–µ—Ö)‚îÇ(–æ—à–∏–±–∫–∞)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    v      v      ‚îÇ     ‚îÇ
         ‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
         ‚îÇ         ‚îÇ –í—ã—Ö–æ–¥  ‚îÇ ‚îÇ–û—à–∏–±–∫–∞ –ë–î ‚îÇ  ‚îÇ
         ‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
         ‚îÇ                          v       ‚îÇ
         ‚îÇ                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
         ‚îÇ                   ‚îÇ –ê–ª–µ—Ä—Ç: –ë–î   ‚îÇ‚îÇ
         ‚îÇ                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
         ‚îÇ                          ‚îÇ       ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ
                                    v
                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚îÇ  –í—ã—Ö–æ–¥  ‚îÇ
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚ö° **–ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –≤–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí –∑–∞–ø–∏—Å—å –≤ –ë–î ‚Üí –æ—Ç–≤–µ—Ç
- üõ°Ô∏è **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ INSERT
- üîî **–†–∞–∑–¥–µ–ª—å–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã**: –æ—Ç–¥–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –ë–î
- üíæ **–°–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å**: –≤—Å–µ –≤–µ–±—Ö—É–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `raw_payload` (JSONB)
- üì± **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –∫–∞–∂–¥—ã–π —Ç–∏–ø –æ—à–∏–±–∫–∏ –∏–º–µ–µ—Ç —Å–≤–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ Telegram –Ω–æ–¥—É

---

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. ‚úÖ `n8n/workflows/Getcourse_webhook_insert.json` - –æ–±–Ω–æ–≤–ª–µ–Ω workflow
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
   - –î–æ–±–∞–≤–ª–µ–Ω–æ —è–≤–Ω–æ–µ `processed = false`
   - –°–æ–∑–¥–∞–Ω–æ 2 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –æ—à–∏–±–æ–∫ (–≤–∞–ª–∏–¥–∞—Ü–∏—è + –ë–î)
   - –ö–∞–∂–¥—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–º–µ–µ—Ç —Å–≤–æ—é Telegram –Ω–æ–¥—É

2. ‚úÖ `n8n/workflows/tests_results/test_run_load.py` - –æ–±–Ω–æ–≤–ª–µ–Ω —Ç–µ—Å—Ç
   - –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö: INTEGER –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫
   - –¢–∞–π–º–∞—É—Ç: 30 ‚Üí 60 —Å–µ–∫—É–Ω–¥
   - –ü–æ—Ä–æ–≥ —É—Å–ø–µ—Ö–∞: 99.9% ‚Üí 100%
   - –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. ‚úÖ `getcourse_bot/REFACTORING_PHASE2.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –§–∞–∑—ã 2

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—á–µ—Ä–µ–∑ Postman)

‚úÖ **–ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:**
- –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–µ–±—Ö—É–∫–∞
- –£—Å–ø–µ—à–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É `webhook_events`
- –ü–æ–ª–µ `processed = false` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- –ü–æ–ª–µ `raw_payload` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π JSON

‚úÖ **–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:**
- –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–æ–ª–µ–º
- –í–∞–ª–∏–¥–∞—Ü–∏—è –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å –≤ –ë–î
- Telegram –∞–ª–µ—Ä—Ç –ø–æ–ª—É—á–µ–Ω —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ—à–∏–±–∫–∏

### –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

‚úÖ **–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (20 –∑–∞–ø—Ä–æ—Å–æ–≤, –∑–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫):**
- –£—Å–ø–µ—Ö: 100% (20/20)
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 0.598 —Å–µ–∫
- –°—Ç–∞—Ç—É—Å: –ü–†–û–ô–î–ï–ù

‚úÖ **–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç (100 –∑–∞–ø—Ä–æ—Å–æ–≤, –∑–∞–¥–µ—Ä–∂–∫–∞ 500ms):**
- –£—Å–ø–µ—Ö: 100% (100/100)
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 7.45 —Å–µ–∫
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: 19.77 —Å–µ–∫
- –°—Ç–∞—Ç—É—Å: –ü–†–û–ô–î–ï–ù

‚ùå **–¢–µ—Å—Ç —Å –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π (100 –∑–∞–ø—Ä–æ—Å–æ–≤, –∑–∞–¥–µ—Ä–∂–∫–∞ 200ms):**
- –£—Å–ø–µ—Ö: 82% (82/100)
- –¢–∞–π–º–∞—É—Ç—ã: 18 –∑–∞–ø—Ä–æ—Å–æ–≤
- –°—Ç–∞—Ç—É—Å: –ù–ï –ü–†–û–ô–î–ï–ù (–æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–∏–ª–∞—Å—å)

**–í—ã–≤–æ–¥:** –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç **2-3 –∑–∞–ø—Ä–æ—Å–∞/—Å–µ–∫** –ø—Ä–∏ –∑–∞–¥–µ—Ä–∂–∫–µ 500ms –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
```bash
# –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç (20 –∑–∞–ø—Ä–æ—Å–æ–≤, –∑–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫)
python test_run_load.py --requests 20 --delay 1.0 --verbose

# –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç (100 –∑–∞–ø—Ä–æ—Å–æ–≤, –∑–∞–¥–µ—Ä–∂–∫–∞ 500ms)
python test_run_load.py --requests 100 --delay-ms 500 --verbose

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç (500 –∑–∞–ø—Ä–æ—Å–æ–≤, –∑–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫)
python test_run_load.py --requests 500 --delay 1.0 --verbose
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:**
- ‚úÖ **–ü–æ—Ä–æ–≥ —É—Å–ø–µ—Ö–∞:** 100% (0 –ø–æ—Ç–µ—Ä—å) - —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞, –≤–∞–∂–Ω–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:** <20 —Å–µ–∫ (–ø—Ä–∏–µ–º–ª–µ–º–æ –¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥)
- ‚úÖ **–ó–∞–ø–∏—Å—å –≤ –ë–î:** –≤—Å–µ —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∑–∞–ø–∏—Å–∞–Ω—ã –≤ `webhook_events`
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è –¥–æ –∑–∞–ø–∏—Å–∏

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ workflow –≤ n8n UI

```bash
# –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π workflow –≤ n8n
# File: n8n/workflows/Getcourse_webhook_insert.json
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- [ ] –ù–æ–¥–∞ "–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö" –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–µ–∂–¥—É Webhook –∏ PostgreSQL
- [ ] –ü–æ–ª–µ `processed = false` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ columns
- [ ] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–ª—É—á—à–µ–Ω–Ω—ã–π JavaScript –∫–æ–¥
- [ ] Connections –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ PostgreSQL

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–µ–π –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞
SELECT
  id,
  user_id,
  user_email,
  answer_id,
  processed,
  created_at,
  raw_payload->>'userId' as raw_user_id  -- –ü—Ä–æ–≤–µ—Ä–∫–∞ JSONB
FROM webhook_events
WHERE created_at > NOW() - INTERVAL '1 hour'
ORDER BY id DESC
LIMIT 10;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
SELECT
  processed,
  COUNT(*) as count
FROM webhook_events
GROUP BY processed;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –í—Å–µ –∑–∞–ø–∏—Å–∏ –∏–º–µ—é—Ç `processed = false`
- ‚úÖ –ü–æ–ª–µ `raw_payload` —Å–æ–¥–µ—Ä–∂–∏—Ç JSONB —Å –∏—Å—Ö–æ–¥–Ω—ã–º webhook
- ‚úÖ –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ö–µ–º–µ (INTEGER –¥–ª—è ID)

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤

**–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–µ–±—Ö—É–∫–∞ —á–µ—Ä–µ–∑ Postman:**
```json
POST https://spiderdad.ru/webhook/getcoursebd

{
  "userEmail": "test@example.com"
  // –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç: eventDate, userId, answerId
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Telegram –∞–ª–µ—Ä—Ç –ø–æ–ª—É—á–µ–Ω
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç: "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: eventDate, userId, answerId"
- ‚úÖ –í –ë–î –∑–∞–ø–∏—Å—å –ù–ï —Å–æ–∑–¥–∞–Ω–∞ (–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ä–∞–±–æ—Ç–∞–ª–∞)

---

## –†–∏—Å–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –†–∏—Å–∫–∏

1. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –≤–µ–±—Ö—É–∫–æ–≤ GetCourse**
   - –†–∏—Å–∫: GetCourse –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É webhook
   - –†–µ—à–µ–Ω–∏–µ: `raw_payload` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–µ—Å—å JSON –¥–ª—è —Ä–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

2. **–õ–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏**
   - –†–∏—Å–∫: –í–∞–ª–∏–¥–∞—Ü–∏—è –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–µ, –Ω–æ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   - –†–µ—à–µ–Ω–∏–µ: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Telegram –∞–ª–µ—Ä—Ç–æ–≤, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å n8n –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ**
   - –†–∏—Å–∫: n8n –º–æ–∂–µ—Ç –Ω–µ —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å –ø–∏–∫–æ–≤—ã–º–∏ –Ω–∞–≥—Ä—É–∑–∫–∞–º–∏
   - –†–µ—à–µ–Ω–∏–µ: –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **JavaScript –≤ Code node** - Python –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –≤ n8n
2. **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –≤–µ–±—Ö—É–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–±–µ–∑ –æ—á–µ—Ä–µ–¥–µ–π)
3. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç PostgreSQL** - –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ë–î –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–∏–µ–º –≤–µ–±—Ö—É–∫–æ–≤

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ n8n

**1. –ß–µ—Ä–µ–∑ n8n UI (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**

```
1. –ó–∞–π—Ç–∏ –≤ n8n: https://spiderdad.ru/
2. –ü–µ—Ä–µ–π—Ç–∏ –≤ "Executions" (–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π)
3. –§–∏–ª—å—Ç—Ä—ã:
   - Status: All / Success / Error
   - Workflow: Getcourse_webhook_insert
   - Time: Last 24 hours
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å:**
- ‚úÖ **Success executions** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫
- ‚ùå **Error executions** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
- ‚è±Ô∏è **Execution time** - –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- üìä **Execution details** - –¥–µ—Ç–∞–ª–∏ –∫–∞–∂–¥–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–≤—Ö–æ–¥–Ω—ã–µ/–≤—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

**2. –ê–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**

```
1. Executions ‚Üí –∫–ª–∏–∫–Ω—É—Ç—å –Ω–∞ execution
2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–π –Ω–æ–¥—ã:
   - Webhook: ~0ms (–ø—Ä–∏–µ–º –∑–∞–ø—Ä–æ—Å–∞)
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö: ~10-50ms
   - –ó–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î: 500ms-15sec (–æ—Å–Ω–æ–≤–Ω–æ–µ –≤—Ä–µ–º—è)
   - –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫—É: ~50-100ms
```

**–ü—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–±–ª–µ–º:**
- ‚ö†Ô∏è –í—Ä–µ–º—è "–ó–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î" > 10 —Å–µ–∫ ‚Üí PostgreSQL –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω
- ‚ö†Ô∏è –ú–Ω–æ–≥–æ Error executions ‚Üí –ø—Ä–æ–±–ª–µ–º—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏–ª–∏ –ë–î
- ‚ö†Ô∏è Execution time —Ä–∞—Å—Ç–µ—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º ‚Üí –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è –æ—á–µ—Ä–µ–¥—å

---

### –û—Ü–µ–Ω–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ PostgreSQL

**1. –ß–µ—Ä–µ–∑ DBeaver (GUI):**

```sql
-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
SELECT
  count(*) as active_connections,
  state,
  wait_event_type,
  wait_event
FROM pg_stat_activity
WHERE datname = 'GetCourseBD'
GROUP BY state, wait_event_type, wait_event;
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å:**
- ‚úÖ `active_connections` < 10 ‚Üí –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- ‚ö†Ô∏è `active_connections` > 50 ‚Üí –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
- ‚ö†Ô∏è `wait_event = 'Lock'` ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–ø—Ä–æ–±–ª–µ–º–∞!)

---

**2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ INSERT –æ–ø–µ—Ä–∞—Ü–∏–π:**

```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
SELECT
  COUNT(*) as total_inserts,
  MIN(created_at) as first_insert,
  MAX(created_at) as last_insert,
  EXTRACT(EPOCH FROM (MAX(created_at) - MIN(created_at))) as duration_seconds,
  COUNT(*) / NULLIF(EXTRACT(EPOCH FROM (MAX(created_at) - MIN(created_at))), 0) as inserts_per_second
FROM webhook_events
WHERE created_at > NOW() - INTERVAL '1 hour';
```

**–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:**
- ‚úÖ `inserts_per_second` < 3 ‚Üí —Å–∏—Å—Ç–µ–º–∞ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
- ‚ö†Ô∏è `inserts_per_second` > 5 ‚Üí –≤–æ–∑–º–æ–∂–Ω—ã –∑–∞–¥–µ—Ä–∂–∫–∏
- ‚ùå `inserts_per_second` > 10 ‚Üí –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞

---

**3. –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –∏ –∏–Ω–¥–µ–∫—Å–æ–≤:**

```sql
-- –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã webhook_events
SELECT
  pg_size_pretty(pg_total_relation_size('webhook_events')) as total_size,
  pg_size_pretty(pg_relation_size('webhook_events')) as table_size,
  pg_size_pretty(pg_indexes_size('webhook_events')) as indexes_size;
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- ‚úÖ `total_size` < 1GB ‚Üí –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- ‚ö†Ô∏è `total_size` > 10GB ‚Üí —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∞—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚ö†Ô∏è `indexes_size` > `table_size` ‚Üí –≤–æ–∑–º–æ–∂–Ω–æ, —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–æ–≤

---

**4. –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã):**

```sql
-- –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏!)
-- –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º –ø–æ—Å—Ç–æ—è–Ω–Ω–æ!
ALTER DATABASE GetCourseBD SET log_min_duration_statement = 1000; -- –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã >1—Å–µ–∫

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
SHOW log_min_duration_statement;

-- –û—Ç–∫–ª—é—á–∏—Ç—å –ø–æ—Å–ª–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
ALTER DATABASE GetCourseBD RESET log_min_duration_statement;
```

---

### Telegram –∞–ª–µ—Ä—Ç—ã

**–ö–∞–Ω–∞–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:** `-1003386133985`

**–¢–∏–ø—ã –∞–ª–µ—Ä—Ç–æ–≤:**
1. üõë **–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏** - –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
2. üõë **–û—à–∏–±–∫–∞ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö** - –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (eventDate –Ω–µ –¥–∞—Ç–∞, userId –Ω–µ —á–∏—Å–ª–æ)
3. üõë **–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ PostgreSQL** - –ø—Ä–æ–±–ª–µ–º—ã —Å –ë–î (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, —Ç–∞–π–º–∞—É—Ç, constraint violation)

**–ü—Ä–∏–º–µ—Ä –∞–ª–µ—Ä—Ç–∞:**
```
üõë –û–®–ò–ë–ö–ê –í N8N WEBHOOK

–ù–æ–¥–∞: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
–û—à–∏–±–∫–∞: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: userId, userEmail

üì¶ –î–∞–Ω–Ω—ã–µ –≤–µ–±—Ö—É–∫–∞:
eventDate: 2025-12-21T12:00:00Z
answerId: 67890

–í—Ä–µ–º—è: 2025-12-21T12:30:45.123Z
```

**–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–ª–µ—Ä—Ç–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å n8n Executions ‚Üí –Ω–∞–π—Ç–∏ Failed execution
2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
3. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç GetCourse
4. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ë–î ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å PostgreSQL –∏ –Ω–∞–≥—Ä—É–∑–∫—É

---

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—Ç–µ–∫—É—â–∏–µ)

**–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã:**
- ‚è±Ô∏è **–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞:** 60 —Å–µ–∫—É–Ω–¥ (–≤ test_run_load.py)
- üìä **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:** 2-3 –∑–∞–ø—Ä–æ—Å–∞/—Å–µ–∫
- üéØ **–¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:** <20 —Å–µ–∫ (–ø—Ä–∏–µ–º–ª–µ–º–æ)
- ‚úÖ **–ü–æ—Ä–æ–≥ —É—Å–ø–µ—Ö–∞:** 100% (0 –ø–æ—Ç–µ—Ä—å)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞–≥—Ä—É–∑–∫–µ:**
- ‚úÖ **–û–ø—Ç–∏–º–∞–ª—å–Ω–æ:** 2 –∑–∞–ø—Ä–æ—Å–∞/—Å–µ–∫ (–∑–∞–¥–µ—Ä–∂–∫–∞ 500ms)
- ‚ö†Ô∏è **–ú–∞–∫—Å–∏–º—É–º:** 3 –∑–∞–ø—Ä–æ—Å–∞/—Å–µ–∫ (–∑–∞–¥–µ—Ä–∂–∫–∞ 333ms)
- ‚ùå **–ö—Ä–∏—Ç–∏—á–Ω–æ:** >5 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫ (–æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω—è–µ—Ç—Å—è)

**–ï—Å–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç—ã:**
1. –£–≤–µ–ª–∏—á–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ GetCourse
2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å PostgreSQL –∏–Ω–¥–µ–∫—Å—ã
3. –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã —Å–µ—Ä–≤–µ—Ä–∞ Amvera (CPU/RAM)
4. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ (Redis/RabbitMQ) - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫—Ä–∞–π–Ω–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–§–∞–∑–∞ 3)

### –ú–∏–≥—Ä–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∏–∑ GAS –≤ Python

**–ó–∞–¥–∞—á–∏:**
1. –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –≤ Python bot:
   - `WebhookProcessingService` - —á—Ç–µ–Ω–∏–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –≤–µ–±—Ö—É–∫–æ–≤
   - `NotificationCalculationService` - —Ä–∞—Å—á–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - `DeadlineCheckService` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–¥–ª–∞–π–Ω–æ–≤
   - `NotificationSenderService` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram

2. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –∏–∑ GAS:
   - `processAnswerToLesson()` ‚Üí Python
   - `checkApproachingDeadlines()` ‚Üí Python
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å APScheduler:
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤: –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–¥–ª–∞–π–Ω–æ–≤: –∫–∞–∂–¥—ã–π —á–∞—Å
   - –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

**–°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É:**
```bash
git checkout -b refactoring/phase3-business-logic
```

---

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ (Checklist)

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ workflow
- [x] –î–æ–±–∞–≤–ª–µ–Ω–æ —è–≤–Ω–æ–µ `processed = false`
- [x] –£–ª—É—á—à–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
- [x] –û–±–Ω–æ–≤–ª–µ–Ω `test_run_load.py`
- [x] –ù–∞–ø–∏—Å–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —á–µ—Ä–µ–∑ Postman
- [x] –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —á–µ—Ä–µ–∑ Postman
- [x] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (20 –∑–∞–ø—Ä–æ—Å–æ–≤, 1 —Å–µ–∫) - ‚úÖ 100% —É—Å–ø–µ—Ö
- [x] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (100 –∑–∞–ø—Ä–æ—Å–æ–≤, 500ms) - ‚úÖ 100% —É—Å–ø–µ—Ö
- [x] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (100 –∑–∞–ø—Ä–æ—Å–æ–≤, 200ms) - ‚ùå 82% (–æ—á–µ—Ä–µ–¥—å)
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–µ–π –≤ PostgreSQL - ‚úÖ –í—Å–µ –∑–∞–ø–∏—Å–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram –∞–ª–µ—Ä—Ç–æ–≤ - ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] REFACTORING_PHASE2.md
- [x] –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ JavaScript –∫–æ–¥–µ
- [x] –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è test_run_load.py

### Deploy
- [ ] Workflow –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ n8n –Ω–∞ Amvera
- [ ] –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω Production webhook URL
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ Production –ë–î
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Telegram –∞–ª–µ—Ä—Ç–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

**–§–∞–∑–∞ 2 –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ì–æ—Ç–æ–≤–æ –∫ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –ø–µ—Ä–µ—Ö–æ–¥—É –∫ –§–∞–∑–µ 3.**
