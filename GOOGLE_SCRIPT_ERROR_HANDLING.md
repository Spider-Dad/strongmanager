# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Google Apps Script

## –ü—Ä–æ–±–ª–µ–º–∞

Google Apps Script –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –æ—à–∏–±–∫–∞–º–∏ –≤–º–µ—Å—Ç–æ JSON –æ—Ç–≤–µ—Ç–æ–≤ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª—É—á–∞—è—Ö:

1. **–û—à–∏–±–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞** - —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –æ—à–∏–±–∫–∏ –ª–æ–≥–∏–∫–∏
2. **–û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** - –Ω–µ–≤–µ—Ä–Ω—ã–µ –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞
3. **–û—à–∏–±–∫–∏ –∫–≤–æ—Ç** - –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ Google Apps Script
4. **–û—à–∏–±–∫–∏ —Å–µ—Ç–∏** - –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Google —Å–µ—Ä–≤–∏—Å–∞–º
5. **–û—à–∏–±–∫–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –†–µ—à–µ–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Content-Type

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Content-Type` –≤ –æ—Ç–≤–µ—Ç–µ:

```python
content_type = response.headers.get('content-type', '').lower()

if 'text/html' in content_type:
    # Google Script –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ JSON - —ç—Ç–æ –æ—à–∏–±–∫–∞
    html_content = await response.text()
    error_message = _extract_error_from_html(html_content)
    raise GoogleScriptError(f"Google Script –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ JSON: {error_message}")
```

### 2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –∏–∑ HTML

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_extract_error_from_html()` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ HTML –æ—Ç–≤–µ—Ç–æ–≤:

```python
def _extract_error_from_html(html_content: str) -> str:
    error_patterns = [
        r'<title[^>]*>([^<]+)</title>',
        r'<h1[^>]*>([^<]+)</h1>',
        r'<div[^>]*class="error"[^>]*>([^<]+)</div>',
        r'<p[^>]*>([^<]+)</p>',
        r'<body[^>]*>([^<]+)</body>'
    ]

    for pattern in error_patterns:
        match = re.search(pattern, html_content, re.IGNORECASE | re.DOTALL)
        if match:
            error_text = match.group(1).strip()
            if error_text and len(error_text) > 10:
                return error_text

    return f"Google Script –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ JSON (–¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(html_content)} —Å–∏–º–≤–æ–ª–æ–≤)"
```

### 3. –ù–æ–≤—ã–µ —Ç–∏–ø—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π

#### GoogleScriptError
–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫ Google Script —Å HTML –æ—Ç–≤–µ—Ç–æ–º:

```python
class GoogleScriptError(Exception):
    def __init__(self, message: str, html_content: str = None, status_code: int = None):
        super().__init__(message)
        self.html_content = html_content
        self.status_code = status_code
```

#### ApiError
–£–ª—É—á—à–µ–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ API —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.

### 4. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º:

```python
logger.error(f"Google Script –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ JSON. Content-Type: {content_type}")
logger.error(f"HTML –æ—Ç–≤–µ—Ç (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤): {html_content[:500]}")
```

### 5. Retry –ª–æ–≥–∏–∫–∞

GoogleScriptError –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è retry:

```python
retry_exceptions=[aiohttp.ClientError, aiohttp.ServerTimeoutError, aiohttp.ClientOSError, GoogleScriptError]
```

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ö–æ–º–∞–Ω–¥–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `/alerts` ‚Üí "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ GScript" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è Google Script.

### –¢–µ—Å—Ç—ã

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test_gs_error_handling.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. –û–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö URL
2. –û–±—Ä–∞–±–æ—Ç–∫–∏ HTML –æ—Ç–≤–µ—Ç–æ–≤
3. –ü–∞—Ä—Å–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫ –∏–∑ HTML
4. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ Google Script

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í –∫–æ–¥–µ

```python
from bot.services.api import make_api_request, GoogleScriptError, ApiError

try:
    result = await make_api_request(api_url, "getNewNotifications", {"limit": 10})
except GoogleScriptError as e:
    logger.error(f"–û—à–∏–±–∫–∞ Google Script: {e}")
    if e.html_content:
        logger.error(f"HTML –æ—Ç–≤–µ—Ç: {e.html_content[:500]}")
except ApiError as e:
    logger.error(f"–û—à–∏–±–∫–∞ API: {e}")
```

### –ß–µ—Ä–µ–∑ Telegram

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/alerts` –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
2. –í—ã–±–µ—Ä–∏—Ç–µ "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ GScript"
3. –ü–æ–ª—É—á–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ Google Script

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ê–ª–µ—Ä—Ç—ã

–í—Å–µ –æ—à–∏–±–∫–∏ Google Script –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –∞–ª–µ—Ä—Ç–æ–≤ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:

- –¢–∏–ø –æ—à–∏–±–∫–∏ (GoogleScriptError/ApiError)
- HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –í—Ä–µ–º—è –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è
- –ú–æ–¥—É–ª—å, –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞

### –õ–æ–≥–∏

–î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:

```
ERROR - Google Script –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ JSON. Content-Type: text/html; charset=utf-8
ERROR - HTML –æ—Ç–≤–µ—Ç (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤): <html><head><title>Google Apps Script Error</title>...
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Google Script

1. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –î–æ–±–∞–≤—å—Ç–µ try-catch –±–ª–æ–∫–∏ –≤ Google Script
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**: –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤—Ö–æ–¥—è—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `Logger.log()` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
4. **–ö–≤–æ—Ç—ã**: –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–∏–º–∏—Ç–∞–º–∏ Google Apps Script

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –±–æ—Ç–∞

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∞–ª–µ—Ä—Ç—ã
2. **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
3. **–õ–æ–≥–∏**: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –æ—à–∏–±–æ–∫
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è**: –°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ Google Apps Script

## –ü—Ä–∏–º–µ—Ä—ã –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
```
Google Script –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ JSON: Access denied. Please check your credentials.
```

### –û—à–∏–±–∫–∞ –∫–≤–æ—Ç
```
Google Script –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ JSON: Quota exceeded for this script.
```

### –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
```
Google Script –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ JSON: TypeError: Cannot read property 'getRange' of null
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ Google Script –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ HTML –æ—Ç–≤–µ—Ç–æ–≤
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
- ‚úÖ Retry –ª–æ–≥–∏–∫—É –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

–≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –æ—Ç–ª–∞–¥–∫—É –±–æ—Ç–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Google Apps Script.